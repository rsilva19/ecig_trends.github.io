---
title: "Exploration Across States: Prevalence and Legislatation"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shinydashboard)
library(tidyverse)
library(viridis)
library(maps)
library(plotly)
library(gganimate)
library(rvest)
library(srvyr)
library(httr)
library(gifski)
```

```{r}
library(rsconnect)
# rsconnect::deployApp("./shiny_legislation_final.Rmd")
# rmarkdown::render("shiny_legislation_final.Rmd", output_format = "flexdashboard::flex_dashboard") # to get html 
```


```{r data, include = FALSE}
# legislation data
legislation_data = read_csv("CDC_State_ECigarette_Legislation_Youth_Access.csv") %>%
  janitor::clean_names() %>% 
  filter(year %in% c(2011:2018),
         !location_desc %in% c('American Samoa', 'Guam', 'Marshall Islands',
                               'Northern Mariana Islands', 'Palau', 'Puerto Rico',
                               'U.S. Virgin Islands', 'District of Columbia'), 
         !is.na(effective_date)) %>% 
  rename(state = location_desc) %>% 
  select(-c(data_source, comments, display_order:provision_id))

# legislation map data
legislation_n = legislation_data %>% 
  group_by(year, state) %>% 
  summarise(n_legislations = n()) 


state_abb = state.name
names(state_abb) = state.abb

# for each year need all states, just NAs if not there
# first find states missing in each year 
all_states = unname(state_abb)
index = 0
list = vector(mode = "list", 
              length = n_distinct(legislation_n %>% pull(year)))
for (yr in c(2011:2018)){
  index = index + 1
  states_not_na = legislation_n %>% 
    filter(year == yr) %>% 
    pull(state)
  missing_states = all_states[!all_states %in% states_not_na]
  list[[index]] = tibble(
    state = missing_states, 
    year = c(rep(yr, length(missing_states))),  
    n_legislations = 0
  )
}
add_df = bind_rows(list)
legislation_full = bind_rows(legislation_n, add_df)

```

Legislation on E-cigarettes over 2011-2018
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
years = unique(legislation_full %>% pull(year))

# selectInput widget
selectInput(
  "year_choice", 
  label = h3("Select year"),
  choices = years, selected = 2018)
```

Row {.tabset .tabset-fade}
-------------------------------------

### US Legislation Map By Year

```{r}
# plot map
renderPlotly({
  legislation_year = legislation_full %>% 
    filter(year ==input[["year_choice"]])

  legislations =  setNames(legislation_year$n_legislations,
                     legislation_year$state)
  g = list(
    scope = 'usa',
    projection = list(type = "state"),
    showlakes = TRUE,
    lakecolor = toRGB('white')
  )

  plot_geo() %>%
    add_trace(
      z = ~legislations, 
      text = state.name, 
      colors = "Blues", 
      span = I(0),
      locations = state.abb, 
      locationmode = 'USA-states',
      showlegend = FALSE
    ) %>%
    layout(geo = g, 
           title = "US Map - Number of Legislations")

})
```


###  Over the Years

```{r}
# state data
states = map_data("state") %>% 
  rename(state = region) %>% 
  select(state, everything(), -subregion)

legislation_n = 
  legislation_n %>% 
  mutate(state = str_to_lower(state))

map_data_leg = left_join(states, legislation_n, by = "state")
```


```{r}

#map_data_leg %>% 
#    filter(year %in% c(2011:2018)) %>% 
#    ggplot() +
#    geom_polygon(aes( x = long, y = lat, group = group, fill = n_legislations), color = "white") #+
#    scale_fill_continuous(low = "white", high = "blue", na.value = "black") +
 #   transition_states(year, wrap = FALSE) +
 #   labs(title = 'Year: {closest_state}', 
  #       fill = "# Legislations")



```


### Description


Row 
-------------------------------------
    
### Explore Legislations

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
years = unique(legislation_n %>% pull(year))

# selectInput widget
selectInput(
  "year_choice", 
  label = h3("Select year"),
  choices = years, selected = 2018)

provision_choice = legislation_data %>% distinct(measure_desc) %>% pull()

# radioButtons widget
radioButtons(
  "provision_choice", 
  label = h3("Choose provision"),
  choices = provision_choice, selected = "E-Cigarette Sales")

provision_grp_choice = legislation_data %>% distinct(provision_group_desc) %>% pull()

# radioButtons widget
radioButtons(
  "provision_grp_choice", 
  label = h3("Choose provision type"),
  choices = provision_grp_choice, selected = "Restrictions")

```
    
```{r}
data = legislation_data %>% 
  filter(provision_value != "No Provision") %>% 
  group_by(year, state, measure_desc, provision_group_desc, provision_desc, provision_value) %>% 
  summarize(n = n())

renderTable({
data %>%  
  filter(year == input[["year_choice"]], measure_desc == input[["provision_choice"]], provision_group_desc == input[["provision_grp_choice"]]) %>% 
  ungroup() %>% 
  filter(provision_desc != "Minimum Age")  %>% 
  distinct(state, provision_desc, provision_value)
})
```


Prevalence 
===================================== 


```{r, include= FALSE}
url = "https://www.cdc.gov/pcd/issues/2019/18_0362.htm"

state_prev_xml = read_html(url)

state_prev = 
  (state_prev_xml %>% html_nodes(css = "table")) %>% 
  .[[1]] %>%
  html_table(fill = TRUE) 

names(state_prev)[1] = "state"
names(state_prev)[2] = "ex1"
names(state_prev)[3] = "ex2"
names(state_prev)[4] = "ex3"
names(state_prev)[5] = "ex4"
names(state_prev)[6] = "ex5"
names(state_prev)[8] = "total_prev"
names(state_prev)[9] = "male_prev"
names(state_prev)[10] = "female_prev"

state_prev = state_prev %>% 
  select(state, total_prev, male_prev, female_prev) %>% 
  slice(3:n())  %>% 
  separate(state, into = c("state", "n"), "\\(") %>% 
  separate(total_prev, into = c("total_prev", "total_CI"), "\\(" ) %>% 
  separate(male_prev, into = c("male_prev", "male_CI"), "\\(" ) %>% 
  separate(female_prev, into = c("female_prev", "female_CI"), "\\(" ) %>% 
  select(state, total_prev, male_prev, female_prev)

state_prev = 
  state_prev %>% 
  mutate(state = str_to_lower(state), 
         state = trimws(state), 
         total_prev = as.numeric(total_prev), 
         male_prev = as.numeric(male_prev), 
         female_prev = as.numeric(female_prev))

# state data
states = map_data("state") %>% 
  rename(state = region) %>% 
  select(state, everything(), -subregion)


# joining datasets 
map_state_prev = left_join(states, state_prev, by = "state")
```


Column {.tabset}
-----------------------------------------------------------------------

### E-Cigarette Prevalence in Adults 

```{r }

prev_plot = 
  map_state_prev  %>% 
  rename(prevalence = "total_prev") %>% 
  ggplot() +
  geom_polygon(aes( x = long, y = lat, group = group, fill = prevalence, subgroup = state), color = "white") +
  scale_fill_continuous(low = "white", high = "red", na.value = "black") +
  labs(
    title = "Prevalence of E-cigarette use by state",
    fill = "Prevalence", 
    x = "", 
    y = "")

ggplotly(prev_plot, tooltip = c("state", "prevalence")) 

```

### Description




